var k=Object.defineProperty;var T=(i,a,r)=>a in i?k(i,a,{enumerable:!0,configurable:!0,writable:!0,value:r}):i[a]=r;var f=(i,a,r)=>T(i,typeof a!="symbol"?a+"":a,r);class P{extractNumber(a){const t=a.replace(/[,‚Ç©$‚Ç¨¬£\s]/g,"").trim().match(/(\d+)/);return t?parseInt(t[1],10):null}extractCurrency(a){return a.includes("Ïõê")||a.includes("KRW")?"KRW":a.includes("$")||a.includes("USD")?"USD":a.includes("‚Ç¨")||a.includes("EUR")?"EUR":a.includes("¬•")||a.includes("JPY")?"JPY":"KRW"}getTextBySelector(a,r){var e;const t=a.querySelector(r);return((e=t==null?void 0:t.textContent)==null?void 0:e.trim())||null}getTextBySelectors(a,r){for(const t of r)try{const e=this.getTextBySelector(a,t);if(e)return e}catch(e){console.debug(`[${this.siteName}] Selector error: ${t}`,e)}return null}isValidPrice(a){return a>100&&a<1e8}}class x extends P{constructor(){super(...arguments);f(this,"siteName","Coupang");f(this,"selectors",{amount:[".price-amount.sales-price-amount",".price-amount.final-price-amount",".total-price",'[data-testid="total-price"]',".price-amount"]})}static isCheckoutPage(r){return/coupang\.com\/vp\//.test(r)||/coupang\.com\/n\//.test(r)||/coupang\.com\/products\//.test(r)}parse(r){try{console.log("[CoupangParser] üîç Parsing Coupang page...");const t=this.extractTitle(r);console.log(`[CoupangParser] Title: ${t||"(not found)"}`);const e=this.extractProductImage(r);e&&console.log(`[CoupangParser] Image: ${e.substring(0,60)}...`);const n=this.extractAllProductImages(r);n.length>0&&console.log(`[CoupangParser] Additional images: ${n.length} found`);const{amount:o,originalPrice:c,discountPrice:l}=this.extractPrices(r);if(!o)return console.debug("[CoupangParser] ‚ùå No price found"),null;console.log(`[CoupangParser] Price: ${o} (original: ${c}, discount: ${l})`);const s=this.extractCardBenefits(r);console.log(`[CoupangParser] Card benefits: ${s.length} found`);const m=this.extractGiftCardDiscount(r);m&&console.log(`[CoupangParser] Gift card discount: ${m.rate}%`);const u=this.extractCashback(r);u&&console.log(`[CoupangParser] Cashback: ${u.amount.toLocaleString()} KRW`);const h=this.extractShippingInfo(r);console.log(`[CoupangParser] Shipping: ${h||"(not found)"}`);const d=this.extractVariants(r);return d.length>0&&console.log(`[CoupangParser] Variants: ${d.length} found`),{amount:o,currency:"KRW",confidence:.95,metadata:{source:"coupang-dom"},title:t,imageUrl:e,images:n,variants:d,originalPrice:c,discountPrice:l,cardBenefits:s,giftCardDiscount:m,cashback:u,shippingInfo:h}}catch(t){return console.error("[CoupangParser] ‚ùå Parse error:",t),null}}extractTitle(r){const t=[".product-title","h1.product-name",'h2[class*="title"]','[data-testid="product-title"]'];for(const e of t){const n=r.querySelector(e);if(n!=null&&n.textContent)return n.textContent.trim()}return null}extractPrices(r){let t=null,e=null,n=null;const o=r.querySelector(".price-amount.sales-price-amount");o!=null&&o.textContent&&(e=this.extractNumber(o.textContent),t=e);const c=r.querySelector(".price-amount.final-price-amount");return c!=null&&c.textContent&&(n=this.extractNumber(c.textContent),n&&(t=n)),t||(t=this.searchPriceInDOM(r)),{amount:t,originalPrice:e,discountPrice:n}}extractCardBenefits(r){var s,m,u,h;const t=[],e=r.querySelector(".ccid-benefit-badge");if(!e)return console.log("[CoupangParser] üìå No card benefit badge found"),t;const n=e.querySelectorAll("img.benefit-ico"),o=[];n.forEach(d=>{const g=d.getAttribute("src");if(g){const p=this.extractCardNameFromUrl(g);p&&o.push(p)}});const c=(m=(s=e.querySelector(".benefit-label"))==null?void 0:s.textContent)==null?void 0:m.trim(),l=(h=(u=e.querySelector(".benefit-label-highlight"))==null?void 0:u.textContent)==null?void 0:h.trim();if(c){const d=this.extractPercentage(c),g=o.length>0?`${o.slice(0,3).join(", ")}${o.length>3?" Ïô∏":""}`:"Ïø†Ìå° ÌååÌä∏ÎÑà Ïπ¥Îìú";t.push({cardName:g,benefit:`${c}${l?` (${l})`:""}`,rate:d}),console.log("[CoupangParser] ‚úÖ Card benefit extracted:",{cards:g,benefit:c,rate:d})}return t}extractCardNameFromUrl(r){const t={shinhan:"Ïã†ÌïúÏπ¥Îìú",woori:"Ïö∞Î¶¨Ïπ¥Îìú",bc:"BCÏπ¥Îìú",lotte:"Î°ØÎç∞Ïπ¥Îìú",kb:"KBÍµ≠ÎØºÏπ¥Îìú",nh:"NHÎÜçÌòëÏπ¥Îìú",samsung:"ÏÇºÏÑ±Ïπ¥Îìú","hana-sk":"ÌïòÎÇòSKÏπ¥Îìú"};for(const[e,n]of Object.entries(t))if(r.includes(e))return n;return null}extractPercentage(r){const t=r.match(/(\d+(?:\.\d+)?)\s*%/);return t?parseFloat(t[1]):void 0}extractShippingInfo(r){var e;const t=r.querySelector('[class*="shipping"]');return((e=t==null?void 0:t.textContent)==null?void 0:e.trim())||null}searchPriceInDOM(r){const t=r.createTreeWalker(r.body,NodeFilter.SHOW_TEXT,null);let e;const n=/(\d{1,3}(?:,\d{3})*)\s*Ïõê/;for(;e=t.nextNode();){const c=(e.textContent||"").match(n);if(c)return console.log(`[CoupangParser] Found price via TreeWalker: "${c[1]}Ïõê"`),this.extractNumber(c[1])}return null}extractGiftCardDiscount(r){const e=r.body.innerText.match(/Í∏∞ÌîÑÌä∏Ïπ¥Îìú\s*(\d+)\s*%/);if(e){const o=parseInt(e[1],10);return{rate:o,description:`Í∏∞ÌîÑÌä∏Ïπ¥Îìú ${o}% Ìï†Ïù∏`}}const n=r.querySelectorAll("div, span, p");for(const o of n){const c=o.textContent||"";if(c.includes("Í∏∞ÌîÑÌä∏Ïπ¥Îìú")&&c.includes("%")){const l=c.match(/(\d+)\s*%/);if(l)return{rate:parseInt(l[1],10),description:c.trim()}}}return null}extractCashback(r){const t=r.querySelectorAll('[class*="cashback"], [class*="Ï†ÅÎ¶Ω"]');for(const o of t){const c=o.textContent||"",l=c.match(/(\d{1,3}(?:,\d{3})*)\s*Ïõê/);if(l&&c.includes("Ïø†Ìå°Ï∫êÏãú")){const s=this.extractNumber(l[1]);if(s)return{amount:s,description:`Ïø†Ìå°Ï∫êÏãú ${s.toLocaleString()} Ïõê Ï†ÅÎ¶Ω`}}}const n=r.body.innerText.match(/(?:ÏµúÎåÄ\s+)?(\d{1,3}(?:,\d{3})*)\s*Ïõê\s*.*?Ïø†Ìå°Ï∫êÏãú\s*Ï†ÅÎ¶Ω/);if(n){const o=this.extractNumber(n[1]);if(o)return{amount:o,description:`Ïø†Ìå°Ï∫êÏãú ${o.toLocaleString()} Ïõê Ï†ÅÎ¶Ω`}}return null}extractProductImage(r){try{const t=r.querySelector("img.twc-w-full.twc-max-h-\\[546px\\]");if(t!=null&&t.src){let n=t.src;return n.startsWith("//")&&(n="https:"+n),n=n.split("?")[0],console.log("[CoupangParser] Main product image from direct selector:",n.substring(0,100)),n}const e=r.querySelector("div.twc-w-\\[70px\\]");if(e){const n=e.querySelector("ul > li:first-child img");if(n){let o=n.src;if(o)return o.startsWith("//")&&(o="https:"+o),o.includes("thumbnails/remote/")&&(o=o.replace(/thumbnails\/remote\/\d+x\d+ex/,"thumbnails/remote/800x800ex")),o=o.split("?")[0],console.log("[CoupangParser] Main product image from gallery:",o.substring(0,100)),o}}return console.log("[CoupangParser] No main product image found"),null}catch(t){return console.error("[CoupangParser] Error extracting main image:",t),null}}extractAllProductImages(r){try{const t=[],e=new Set,n=r.querySelector("div.twc-w-\\[70px\\]");if(n){const o=n.querySelectorAll("ul > li img");console.log("[CoupangParser] Thumbnail gallery found with",o.length,"items");for(const c of o){let s=c.src;if(s&&!e.has(s)&&(s.startsWith("//")&&(s="https:"+s),s.includes("thumbnails/remote/")&&(s=s.replace(/thumbnails\/remote\/\d+x\d+ex/,"thumbnails/remote/800x800ex")),s=s.split("?")[0],!e.has(s)&&(t.push(s),e.add(s),console.log("[CoupangParser] Added slide image:",s.substring(0,100)),t.length>=10)))break}}return console.log("[CoupangParser] Total product slide images collected:",t.length),t}catch(t){return console.error("[CoupangParser] Error extracting all images:",t),[]}}extractVariants(r){try{const t=[],e=new Set,n=r.querySelector(".instant-option");if(!n)return console.log("[CoupangParser] No .instant-option found"),t;console.log("[CoupangParser] Found .instant-option section");const o=n.querySelectorAll("section > ul > li");console.log("[CoupangParser] List items in instant-option:",o.length);for(const c of o)try{const l=c.querySelectorAll("div");if(l.length<2)continue;let s="";for(const d of l){const g=d.textContent||"";if(!g.includes("Ïõê")&&g.trim().length>0&&!g.includes("px")){s=g.trim();break}}let m="";for(const d of l){const p=(d.textContent||"").match(/[\d,]+Ïõê/);if(p){m=p[0].replace(/[,Ïõê]/g,"");break}}if(!m)continue;const u=parseInt(m);if(!u||u<100||!s||s.length<2)continue;const h=`${s}-${u}`;if(e.has(h))continue;if(t.push({name:s,price:u}),e.add(h),console.log(`[CoupangParser] Added variant: ${s} - ‚Ç©${u.toLocaleString()}`),t.length>=15)break}catch(l){console.warn("[CoupangParser] Error parsing list item:",l);continue}return console.log("[CoupangParser] Total variants extracted:",t.length),t}catch(t){return console.error("[CoupangParser] Error extracting variants:",t),[]}}}class y extends P{constructor(){super(...arguments);f(this,"siteName","Amazon");f(this,"selectors",{amount:[".a-price-whole",'[data-a-color="price"]',".a-price",'[class*="price"]']})}static isCheckoutPage(r){return/amazon\.(com|co\.uk|de|fr|it|es|ca|jp|cn|in|ae|sg|com\.br|com\.mx)/.test(r)}parse(r){try{console.log("[AmazonParser] üîç Parsing Amazon page...");let t=this.getTextBySelectors(r,this.selectors.amount);if(t||(console.log("[AmazonParser] Trying full DOM search..."),t=this.searchPriceInDOM(r)),!t)return console.debug("[AmazonParser] ‚ùå Amount not found"),null;const e=this.extractNumber(t);if(!e||!this.isValidPrice(e))return console.debug("[AmazonParser] ‚ùå Invalid amount:",e),null;const n=this.extractCurrency(t);return console.log(`[AmazonParser] ‚úÖ Found: ${e} ${n}`),{amount:e,currency:n,confidence:.9,metadata:{source:"amazon-dom"}}}catch(t){return console.error("[AmazonParser] ‚ùå Parse error:",t),null}}searchPriceInDOM(r){const t=r.createTreeWalker(r.body,NodeFilter.SHOW_TEXT,null);let e;const n=/\$[\d,]+\.?\d*/;for(;e=t.nextNode();){const c=(e.textContent||"").match(n);if(c)return console.log(`[AmazonParser] Found price in text: "${c[0]}"`),c[0]}return null}}class S extends P{constructor(){super(...arguments);f(this,"siteName","eBay");f(this,"selectors",{amount:[".vi-VR-cvipPrice",'[id*="vi_ird_finalPrice"]',".vi-acc-del-range",'[class*="price"]']})}static isCheckoutPage(r){return/ebay\.(com|co\.uk|de|fr|it|es|ca)/.test(r)}parse(r){try{console.log("[EbayParser] üîç Parsing eBay page...");let t=this.getTextBySelectors(r,this.selectors.amount);if(t||(console.log("[EbayParser] Trying full DOM search..."),t=this.searchPriceInDOM(r)),!t)return console.debug("[EbayParser] ‚ùå Amount not found"),null;const e=this.extractNumber(t);if(!e||!this.isValidPrice(e))return console.debug("[EbayParser] ‚ùå Invalid amount:",e),null;const n=this.extractCurrency(t);return console.log(`[EbayParser] ‚úÖ Found: ${e} ${n}`),{amount:e,currency:n,confidence:.85,metadata:{source:"ebay-dom"}}}catch(t){return console.error("[EbayParser] ‚ùå Parse error:",t),null}}searchPriceInDOM(r){const t=r.createTreeWalker(r.body,NodeFilter.SHOW_TEXT,null);let e;const n=/\$[\d,]+\.?\d*/;for(;e=t.nextNode();){const c=(e.textContent||"").match(n);if(c)return console.log(`[EbayParser] Found price in text: "${c[0]}"`),c[0]}return null}}class N extends P{constructor(){super(...arguments);f(this,"siteName","Fallback");f(this,"selectors",{amount:[]})}parse(r){var t;try{console.log("[FallbackParser] üîç Fallback parsing (text heuristic)...");const n=(((t=r.body)==null?void 0:t.textContent)||"").match(/(\d{1,3}(?:,\d{3})*)\s*Ïõê/);if(!n)return console.debug('[FallbackParser] ‚ùå No price with "Ïõê" found'),null;const o=this.extractNumber(n[1]);return!o||!this.isValidPrice(o)?(console.debug("[FallbackParser] ‚ùå Invalid amount:",o),null):(console.log(`[FallbackParser] ‚úÖ Found: ${o} KRW (via text heuristic)`),{amount:o,currency:"KRW",confidence:.5,metadata:{source:"fallback-heuristic"}})}catch(e){return console.error("[FallbackParser] ‚ùå Parse error:",e),null}}}if(window.self!==window.top){const i=window.location.href,a=window.location.hostname,r=window.location.pathname;console.debug("[ContentScript:iframe] üìç Iframe detected",{context:"iframe",url:i,host:a,pathname:r,selfIsTop:window.self===window.top})}console.log("[ContentScript] ‚úÖ Content script initialized in main frame");function $(){const i=window.location.href;return x.isCheckoutPage(i)?{site:"coupang",isCheckout:!0}:y.isCheckoutPage(i)?{site:"amazon",isCheckout:!0}:S.isCheckoutPage(i)?{site:"ebay",isCheckout:!0}:{site:"unknown",isCheckout:!1}}function A(i){switch(i){case"coupang":return new x;case"amazon":return new y;case"ebay":return new S;default:return null}}function w(){const{site:i,isCheckout:a}=$();if(!a)return console.log("[ContentScript] Not a checkout page"),null;console.log(`[ContentScript] Checkout detected: ${i}`);const r=A(i);if(r){const e=r.parse(document);if(e)return e}return console.log("[ContentScript] Trying fallback..."),new N().parse(document)}function v(i){chrome.runtime.sendMessage({type:"SAVE_PRODUCT_DATA",data:i,url:window.location.href,timestamp:Date.now()},a=>{var r,t;a!=null&&a.success?(console.log("[ContentScript] ‚úÖ Data saved, triggering popup...",{responseSuccess:a.success,savedAmount:(r=a.savedData)==null?void 0:r.amount,savedCurrency:(t=a.savedData)==null?void 0:t.currency}),console.log("[ContentScript] üé™ Opening Auto Popup (SubPopup window)"),chrome.runtime.sendMessage({type:"OPEN_AUTO_POPUP"},e=>{e!=null&&e.success?console.log("[ContentScript] ‚úÖ Auto Popup window opened"):console.warn("[ContentScript] ‚ö†Ô∏è Failed to open Auto Popup:",e==null?void 0:e.error)})):console.error("[ContentScript] ‚ùå Background error:",{error:a==null?void 0:a.error,message:a==null?void 0:a.message})})}function C(){if(console.log("[ContentScript] Initializing..."),window.self!==window.top){console.debug("[ContentScript] Skipping - running in iframe context");return}const i=w();if(!i){console.warn("[ContentScript] Failed to extract");return}console.log("[ContentScript] Extracted data:",i),console.log("[ContentScript] Sending to background..."),v(i)}function b(){const i=new MutationObserver(a=>{a.some(t=>t.addedNodes.length>0&&Array.from(t.addedNodes).some(e=>e.tagName==="IFRAME"||e instanceof Element&&e.querySelector("iframe")))&&(console.log("[ContentScript] üîÑ New iframe detected, re-parsing dynamic content..."),setTimeout(()=>{const t=w();t&&(console.log("[ContentScript] ‚úÖ Dynamic content re-parsed:",t),chrome.runtime.sendMessage({type:"UPDATE_PRODUCT_DATA",data:t,timestamp:Date.now(),source:"dynamic-iframe"},e=>{e!=null&&e.success&&console.log("[ContentScript] ‚úÖ Dynamic data updated in storage")}))},500),i.disconnect())});i.observe(document.body,{childList:!0,subtree:!0,attributes:!1}),console.log("[ContentScript] üì° Dynamic content observer started")}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{C(),b()}):(C(),b());
