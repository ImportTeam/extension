console.log("[Background] üü¢ Service Worker initialized");chrome.runtime.onMessage.addListener((r,d,o)=>{console.log("[Background] üì® Message received",{type:r.type,senderUrl:d.url,senderTab:d.tab?.id});try{if(r.type==="SAVE_PRODUCT_DATA"){const{data:t,url:c,timestamp:a}=r;console.log("[Background] üíæ Saving product data:",{amount:t.amount,currency:t.currency,title:t.title?.substring(0,50)+"...",url:c,timestamp:new Date(a).toISOString()});const e={...t,url:c,timestamp:a,savedAt:new Date().toISOString()};return chrome.storage.local.set({currentProduct:e,lastUpdated:a},()=>{console.log("[Background] ‚úÖ Data saved to chrome.storage.local"),console.log("[Background] üìä Stored product:",{amount:e.amount,currency:e.currency,title:e.title?.substring(0,50)+"..."}),o({success:!0,message:"Data saved to storage",savedData:{amount:e.amount,currency:e.currency}})}),!0}if(r.type==="GET_PRODUCT_DATA")return console.log("[Background] üîç GET_PRODUCT_DATA request"),chrome.storage.local.get(["currentProduct"],t=>{console.log("[Background] üì¶ Retrieved product data:",{exists:!!t.currentProduct,amount:t.currentProduct?.amount,title:t.currentProduct?.title?.substring(0,50)+"..."}),o({success:!0,data:t.currentProduct||null})}),!0;if(r.type==="OPEN_AUTO_POPUP")return console.log("[Background] üé™ Opening Auto Popup (SubPopup window)"),chrome.windows.create({url:chrome.runtime.getURL("src/subpopup/index.html?auto=true"),type:"popup",width:420,height:300},t=>{chrome.runtime.lastError?(console.error("[Background] ‚ùå Failed to open Auto Popup:",chrome.runtime.lastError),o({success:!1,error:chrome.runtime.lastError.message})):(console.log("[Background] ‚úÖ Auto Popup window created:",{windowId:t?.id,width:t?.width,height:t?.height}),o({success:!0,windowId:t?.id}))}),!0;if(r.type==="UPDATE_PRODUCT_DATA"){const{data:t,timestamp:c,source:a}=r;return console.log("[Background] üîÑ Updating product data (dynamic content):",{amount:t.amount,currency:t.currency,title:t.title?.substring(0,50)+"...",source:a,timestamp:new Date(c).toISOString()}),chrome.storage.local.get(["currentProduct"],e=>{const n=e.currentProduct,u={...n,...t,url:n?.url||t.url,timestamp:n?.timestamp||c,updatedAt:new Date().toISOString(),updateSource:a};chrome.storage.local.set({currentProduct:u,lastUpdated:c},()=>{console.log("[Background] ‚úÖ Product data updated:",{amount:u.amount,cardBenefits:u.cardBenefits?.length||0,hasCashback:!!u.cashback}),o({success:!0,message:"Data updated from dynamic content",updatedData:{amount:u.amount,cardBenefits:u.cardBenefits}})})}),!0}console.warn("[Background] ‚ö†Ô∏è Unknown message type:",r.type),o({success:!1,error:"Unknown message type"})}catch(t){console.error("[Background] ‚ùå Error:",t),o({success:!1,error:String(t)})}return!1});
