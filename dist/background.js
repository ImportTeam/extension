console.log("[Background] üü¢ Service Worker initialized");chrome.runtime.onMessage.addListener((e,s,a)=>{console.log("[Background] üì® Message received",{type:e.type,senderUrl:s.url,senderTab:s.tab?.id});try{if(e.type==="SAVE_PRODUCT_DATA"){const{data:t,url:r,timestamp:c}=e;console.log("[Background] üíæ Saving product data:",{amount:t.amount,currency:t.currency,title:t.title?.substring(0,50)+"...",url:r,timestamp:new Date(c).toISOString()});const o={...t,url:r,timestamp:c,savedAt:new Date().toISOString()};return chrome.storage.local.set({currentProduct:o,lastUpdated:c},()=>{console.log("[Background] ‚úÖ Data saved to chrome.storage.local"),console.log("[Background] üìä Stored product:",{amount:o.amount,currency:o.currency,title:o.title?.substring(0,50)+"..."}),a({success:!0,message:"Data saved to storage",savedData:{amount:o.amount,currency:o.currency}})}),!0}if(e.type==="GET_PRODUCT_DATA")return console.log("[Background] üîç GET_PRODUCT_DATA request"),chrome.storage.local.get(["currentProduct"],t=>{const r=t.currentProduct;console.log("[Background] üì¶ Retrieved product data:",{exists:!!r,amount:r?.amount,title:r?.title?.substring(0,50)+"..."}),a({success:!0,data:t.currentProduct||null})}),!0;if(e.type==="OPEN_AUTO_POPUP")return console.log("[Background] üé™ Opening Auto Popup (SubPopup window)"),chrome.windows.create({url:chrome.runtime.getURL("src/subpopup/index.html?auto=true"),type:"popup",width:420,height:300},t=>{chrome.runtime.lastError?(console.error("[Background] ‚ùå Failed to open Auto Popup:",chrome.runtime.lastError),a({success:!1,error:chrome.runtime.lastError.message})):(console.log("[Background] ‚úÖ Auto Popup window created:",{windowId:t?.id,width:t?.width,height:t?.height}),a({success:!0,windowId:t?.id}))}),!0;if(e.type==="UPDATE_PRODUCT_DATA"){const{data:t,timestamp:r,source:c}=e;return console.log("[Background] üîÑ Updating product data (dynamic content):",{amount:t.amount,currency:t.currency,title:t.title?.substring(0,50)+"...",source:c,timestamp:new Date(r).toISOString()}),chrome.storage.local.get(["currentProduct"],o=>{const n=o.currentProduct||{},u={...n,...t,url:n?.url||t.url,timestamp:n?.timestamp||r,updatedAt:new Date().toISOString(),updateSource:c};chrome.storage.local.set({currentProduct:u,lastUpdated:r},()=>{console.log("[Background] ‚úÖ Product data updated:",{amount:u.amount,cardBenefits:u.cardBenefits?.length||0,hasCashback:!!u.cashback}),a({success:!0,message:"Data updated from dynamic content",updatedData:{amount:u.amount,cardBenefits:u.cardBenefits}})})}),!0}console.warn("[Background] ‚ö†Ô∏è Unknown message type:",e.type),a({success:!1,error:"Unknown message type"})}catch(t){console.error("[Background] ‚ùå Error:",t),a({success:!1,error:String(t)})}return!1});
