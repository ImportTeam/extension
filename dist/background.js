console.log("[Background] üü¢ Service Worker initialized");chrome.runtime.onMessage.addListener((a,s,u)=>{var l,d,g;console.log("[Background] üì® Message received",{type:a.type,senderUrl:s.url,senderTab:(l=s.tab)==null?void 0:l.id});try{if(a.type==="SAVE_PRODUCT_DATA"){const{data:t,url:o,timestamp:c}=a;console.log("[Background] üíæ Saving product data:",{amount:t.amount,currency:t.currency,title:((d=t.title)==null?void 0:d.substring(0,50))+"...",url:o,timestamp:new Date(c).toISOString()});const r={...t,url:o,timestamp:c,savedAt:new Date().toISOString()};return chrome.storage.local.set({currentProduct:r,lastUpdated:c},()=>{var e;console.log("[Background] ‚úÖ Data saved to chrome.storage.local"),console.log("[Background] üìä Stored product:",{amount:r.amount,currency:r.currency,title:((e=r.title)==null?void 0:e.substring(0,50))+"..."}),u({success:!0,message:"Data saved to storage",savedData:{amount:r.amount,currency:r.currency}})}),!0}if(a.type==="GET_PRODUCT_DATA")return console.log("[Background] üîç GET_PRODUCT_DATA request"),chrome.storage.local.get(["currentProduct"],t=>{var o,c,r;console.log("[Background] üì¶ Retrieved product data:",{exists:!!t.currentProduct,amount:(o=t.currentProduct)==null?void 0:o.amount,title:((r=(c=t.currentProduct)==null?void 0:c.title)==null?void 0:r.substring(0,50))+"..."}),u({success:!0,data:t.currentProduct||null})}),!0;if(a.type==="OPEN_AUTO_POPUP")return console.log("[Background] üé™ Opening Auto Popup (SubPopup window)"),chrome.windows.create({url:chrome.runtime.getURL("src/subpopup/index.html?auto=true"),type:"popup",width:420,height:300},t=>{chrome.runtime.lastError?(console.error("[Background] ‚ùå Failed to open Auto Popup:",chrome.runtime.lastError),u({success:!1,error:chrome.runtime.lastError.message})):(console.log("[Background] ‚úÖ Auto Popup window created:",{windowId:t==null?void 0:t.id,width:t==null?void 0:t.width,height:t==null?void 0:t.height}),u({success:!0,windowId:t==null?void 0:t.id}))}),!0;if(a.type==="UPDATE_PRODUCT_DATA"){const{data:t,timestamp:o,source:c}=a;return console.log("[Background] üîÑ Updating product data (dynamic content):",{amount:t.amount,currency:t.currency,title:((g=t.title)==null?void 0:g.substring(0,50))+"...",source:c,timestamp:new Date(o).toISOString()}),chrome.storage.local.get(["currentProduct"],r=>{const e=r.currentProduct,n={...e,...t,url:(e==null?void 0:e.url)||t.url,timestamp:(e==null?void 0:e.timestamp)||o,updatedAt:new Date().toISOString(),updateSource:c};chrome.storage.local.set({currentProduct:n,lastUpdated:o},()=>{var m;console.log("[Background] ‚úÖ Product data updated:",{amount:n.amount,cardBenefits:((m=n.cardBenefits)==null?void 0:m.length)||0,hasCashback:!!n.cashback}),u({success:!0,message:"Data updated from dynamic content",updatedData:{amount:n.amount,cardBenefits:n.cardBenefits}})})}),!0}console.warn("[Background] ‚ö†Ô∏è Unknown message type:",a.type),u({success:!1,error:"Unknown message type"})}catch(t){console.error("[Background] ‚ùå Error:",t),u({success:!1,error:String(t)})}return!1});
