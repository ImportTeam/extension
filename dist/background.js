import{n as l,E as d,s as i,e as g}from"./assets/index-CtnQ7lw9.js";var A={};const D=typeof process<"u"&&A?.VITE_BACKEND_URL||"http://localhost:8000",_=String(D).replace(/\/$/,"");async function C(t,e,r,a,s){const n=new AbortController,m=setTimeout(()=>n.abort(),15e3),o=String(t??"").trim(),E=`${_}/api/v1/price/search`,p={product_name:o};r&&(p.current_price=r),a&&(p.current_url=a),s&&s.length>0&&(p.selected_options=s);const S=Date.now();console.info("üîó [BACKEND] Fetching price comparison:",{url:E,body:p,providers:e||"all"});try{const c=await fetch(E,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(p),signal:n.signal});if(console.info("üì° [BACKEND] Response status:",c.status),!c.ok)throw c.status===404?new Error("ÏÉÅÌíàÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§. (404)"):c.status===400?new Error("ÏöîÏ≤≠ ÌååÎùºÎØ∏ÌÑ∞Í∞Ä Ïò¨Î∞îÎ•¥ÏßÄ ÏïäÏäµÎãàÎã§. (400)"):new Error(`API ÏöîÏ≤≠ Ïã§Ìå®: ${c.status}`);const f=await c.json();if(console.info("‚úÖ [BACKEND] Response data:",f),f.status!=="success"||!f.data)throw new Error(f.message||"Í≤ÄÏÉâ Ïã§Ìå®");const w=Date.now()-S,h=f.data,y=Array.isArray(h.top_prices)?h.top_prices.filter(u=>u&&typeof u.price=="number").map(u=>({id:`${u.rank}`,name:u.mall,price:u.price,currency:"KRW",url:u.link||"",isFreeShipping:!!u.free_shipping,deliveryInfo:u.delivery})):[];return{success:!0,query:o,results:[{provider:"danawa",success:!0,products:y,duration:w}],totalDuration:w,fromCache:!1,is_cheaper:h.is_cheaper,price_diff:h.price_diff,lowest_price:h.lowest_price,mall:h.mall,link:h.link}}catch(c){throw console.error("‚ùå [BACKEND] Fetch error:",c),c instanceof Error&&c.name==="AbortError"?new Error("ÏöîÏ≤≠ ÏãúÍ∞Ñ Ï¥àÍ≥º (15Ï¥à)"):c}finally{clearTimeout(m)}}async function P(){const t=new AbortController,e=setTimeout(()=>t.abort(),5e3);try{const r=await fetch(`${_}/health`,{signal:t.signal});let a=null;try{a=await r.json()}catch{}return{ok:r.ok,status:r.status,data:a}}catch(r){throw r instanceof Error&&r.name==="AbortError"?new Error("ÏÑúÎ≤Ñ ÏùëÎãµ ÏãúÍ∞Ñ Ï¥àÍ≥º"):new Error("Í∞ÄÍ≤© ÎπÑÍµê ÏÑúÎ≤ÑÏóê Ïó∞Í≤∞Ìï† Ïàò ÏóÜÏäµÎãàÎã§")}finally{clearTimeout(e)}}function T(t,e){const{data:r,url:a,timestamp:s}=t;i.info("üíæ Saving product data",{amount:r.amount,currency:r.currency,title:`${r.title?.substring(0,50)}...`,url:a,timestamp:new Date(s).toISOString()});const n={...r,url:a,timestamp:s,savedAt:new Date().toISOString()};return chrome.storage.local.set({currentProduct:n,lastUpdated:s},()=>{if(chrome.runtime.lastError){i.error(d.STO_E001,"Failed to save to chrome.storage.local",{error:new Error(chrome.runtime.lastError.message||"Storage error")}),e({success:!1,error:chrome.runtime.lastError.message});return}i.info("‚úÖ Data saved to chrome.storage.local"),i.debug("üìä Stored product",{amount:n.amount,currency:n.currency,title:`${n.title?.substring(0,50)}...`}),e({success:!0,message:"Data saved to storage",savedData:{amount:n.amount,currency:n.currency}})}),!0}function O(t){return i.debug("üîç GET_PRODUCT_DATA request"),chrome.storage.local.get(["currentProduct"],e=>{if(chrome.runtime.lastError){i.error(d.STO_E001,"Failed to get from chrome.storage.local",{error:new Error(chrome.runtime.lastError.message||"Storage error")}),t({success:!1,error:chrome.runtime.lastError.message,data:null});return}const r=e.currentProduct;i.debug("üì¶ Retrieved product data",{exists:!!r,amount:r?.amount,title:r?.title?`${r.title.substring(0,50)}...`:"N/A"}),t({success:!0,data:e.currentProduct||null})}),!0}function v(t){return g.info("üé™ Opening Auto Popup (SubPopup window)"),chrome.windows.create({url:chrome.runtime.getURL("src/subpopup/index.html?auto=true"),type:"popup",width:420,height:300},e=>{chrome.runtime.lastError?(g.error(d.EXT_E002,"Failed to open Auto Popup",{error:new Error(chrome.runtime.lastError.message||"Unknown error")}),t({success:!1,error:chrome.runtime.lastError.message})):(g.info("‚úÖ Auto Popup window created",{windowId:e?.id,width:e?.width,height:e?.height}),t({success:!0,windowId:e?.id}))}),!0}function b(t,e){const{query:r,providers:a,currentPrice:s,currentUrl:n,selectedOptions:m}=t;return l.info("üí∞ [BACKEND] Price comparison request received",{query:r,providers:a||"all",currentPrice:s,currentUrl:n,selectedOptionsCount:m?.length||0,timestamp:new Date().toISOString()}),C(r,a,s,n,m).then(o=>{l.info("‚úÖ [BACKEND] Price comparison completed",{success:o.success,resultCount:o.results.length,totalDuration:o.totalDuration,fromCache:o.fromCache,query:r}),e({success:!0,data:o})}).catch(o=>{l.error(d.NET_E002,"[BACKEND] Price comparison failed",{error:o instanceof Error?o:new Error(String(o)),data:{query:r}}),e({success:!1,error:o instanceof Error?o.message:"Í∞ÄÍ≤© ÎπÑÍµê Ïã§Ìå®"})}),!0}function N(t){return l.debug("üîç [BACKEND] Checking comparison server status"),P().then(e=>{l.info("‚úÖ [BACKEND] Comparison server is healthy",e),t({success:!0,data:e})}).catch(e=>{const r=e instanceof Error?e.message:"Í∞ÄÍ≤© ÎπÑÍµê ÏÑúÎ≤ÑÏóê Ïó∞Í≤∞Ìï† Ïàò ÏóÜÏäµÎãàÎã§";l.error(d.NET_E001,"‚ùå [BACKEND] Comparison server is down",{error:e instanceof Error?e:new Error(String(e))}),t({success:!1,error:r})}),!0}function U(t,e){const{data:r,timestamp:a,source:s}=t;return i.info("üîÑ Updating product data (dynamic content)",{amount:r.amount,currency:r.currency,title:`${r.title?.substring(0,50)}...`,source:s,timestamp:new Date(a).toISOString()}),chrome.storage.local.get(["currentProduct"],n=>{if(chrome.runtime.lastError){i.error(d.STO_E001,"Failed to get existing data",{error:new Error(chrome.runtime.lastError.message||"Storage error")}),e({success:!1,error:chrome.runtime.lastError.message});return}const m=n.currentProduct||{},o={...m,...r,url:m?.url||r.url,timestamp:m?.timestamp||a,updatedAt:new Date().toISOString(),updateSource:s};chrome.storage.local.set({currentProduct:o,lastUpdated:a},()=>{if(chrome.runtime.lastError){i.error(d.STO_E001,"Failed to update data",{error:new Error(chrome.runtime.lastError.message||"Storage error")}),e({success:!1,error:chrome.runtime.lastError.message});return}i.info("‚úÖ Product data updated",{amount:o.amount,cardBenefits:o.cardBenefits?.length||0,hasCashback:!!o.cashback}),e({success:!0,message:"Data updated from dynamic content",updatedData:{amount:o.amount,cardBenefits:o.cardBenefits}})})}),!0}function k(){chrome.runtime.onMessage.addListener((t,e,r)=>{l.info("üì® Message received",{type:t.type,senderUrl:e.url,senderTab:e.tab?.id});try{switch(t.type){case"SAVE_PRODUCT_DATA":return T(t,r);case"GET_PRODUCT_DATA":return O(r);case"OPEN_AUTO_POPUP":return v(r);case"COMPARE_PRICES":return b(t,r);case"CHECK_COMPARISON_SERVER":return N(r);case"UPDATE_PRODUCT_DATA":return U(t,r);default:return l.warn("‚ö†Ô∏è Unknown message type",{type:t.type}),r({success:!1,error:"Unknown message type"}),!1}}catch(a){return l.error(d.NET_E001,"Message handling error",{error:a instanceof Error?a:new Error(String(a))}),r({success:!1,error:String(a)}),!1}})}g.info("üü¢ Service Worker initialized");k();
