import{e as m,n,s as u,E as d}from"./assets/index-CtnQ7lw9.js";m.info("üü¢ Service Worker initialized");const l="http://localhost:8000";async function h(a,s){const e=await fetch(`${l}/api/compare`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:a,providers:s,maxResults:5})});if(!e.ok)throw new Error(`API ÏöîÏ≤≠ Ïã§Ìå®: ${e.status}`);return e.json()}chrome.runtime.onMessage.addListener((a,s,e)=>{n.info("üì® Message received",{type:a.type,senderUrl:s.url,senderTab:s.tab?.id});try{if(a.type==="SAVE_PRODUCT_DATA"){const{data:t,url:o,timestamp:r}=a;u.info("üíæ Saving product data",{amount:t.amount,currency:t.currency,title:`${t.title?.substring(0,50)}...`,url:o,timestamp:new Date(r).toISOString()});const c={...t,url:o,timestamp:r,savedAt:new Date().toISOString()};return chrome.storage.local.set({currentProduct:c,lastUpdated:r},()=>{u.info("‚úÖ Data saved to chrome.storage.local"),u.debug("üìä Stored product",{amount:c.amount,currency:c.currency,title:`${c.title?.substring(0,50)}...`}),e({success:!0,message:"Data saved to storage",savedData:{amount:c.amount,currency:c.currency}})}),!0}if(a.type==="GET_PRODUCT_DATA")return u.debug("üîç GET_PRODUCT_DATA request"),chrome.storage.local.get(["currentProduct"],t=>{const o=t.currentProduct;u.debug("üì¶ Retrieved product data",{exists:!!o,amount:o?.amount,title:o?.title?`${o.title.substring(0,50)}...`:"N/A"}),e({success:!0,data:t.currentProduct||null})}),!0;if(a.type==="OPEN_AUTO_POPUP")return m.info("üé™ Opening Auto Popup (SubPopup window)"),chrome.windows.create({url:chrome.runtime.getURL("src/subpopup/index.html?auto=true"),type:"popup",width:420,height:300},t=>{chrome.runtime.lastError?(m.error(d.EXT_E002,"Failed to open Auto Popup",{error:new Error(chrome.runtime.lastError.message||"Unknown error")}),e({success:!1,error:chrome.runtime.lastError.message})):(m.info("‚úÖ Auto Popup window created",{windowId:t?.id,width:t?.width,height:t?.height}),e({success:!0,windowId:t?.id}))}),!0;if(a.type==="COMPARE_PRICES"){const{query:t,providers:o}=a;return n.info("üí∞ Price comparison request",{query:t,providers:o||"all"}),h(t,o).then(r=>{n.info("‚úÖ Price comparison completed",{success:r.success,resultCount:r.results.length,totalDuration:r.totalDuration,fromCache:r.fromCache}),e({success:!0,data:r})}).catch(r=>{n.error(d.NET_E002,"Price comparison failed",{error:r instanceof Error?r:new Error(String(r))}),e({success:!1,error:r instanceof Error?r.message:"Í∞ÄÍ≤© ÎπÑÍµê Ïã§Ìå®"})}),!0}if(a.type==="CHECK_COMPARISON_SERVER")return n.debug("üîç Checking comparison server status"),fetch(`${l}/api/health`).then(t=>t.json()).then(t=>{n.info("‚úÖ Comparison server is healthy",t),e({success:!0,data:t})}).catch(t=>{n.error(d.NET_E001,"Comparison server is down",{error:t instanceof Error?t:new Error(String(t))}),e({success:!1,error:"Í∞ÄÍ≤© ÎπÑÍµê ÏÑúÎ≤ÑÏóê Ïó∞Í≤∞Ìï† Ïàò ÏóÜÏäµÎãàÎã§"})}),!0;if(a.type==="UPDATE_PRODUCT_DATA"){const{data:t,timestamp:o,source:r}=a;return u.info("üîÑ Updating product data (dynamic content)",{amount:t.amount,currency:t.currency,title:`${t.title?.substring(0,50)}...`,source:r,timestamp:new Date(o).toISOString()}),chrome.storage.local.get(["currentProduct"],c=>{const p=c.currentProduct||{},i={...p,...t,url:p?.url||t.url,timestamp:p?.timestamp||o,updatedAt:new Date().toISOString(),updateSource:r};chrome.storage.local.set({currentProduct:i,lastUpdated:o},()=>{u.info("‚úÖ Product data updated",{amount:i.amount,cardBenefits:i.cardBenefits?.length||0,hasCashback:!!i.cashback}),e({success:!0,message:"Data updated from dynamic content",updatedData:{amount:i.amount,cardBenefits:i.cardBenefits}})})}),!0}n.warn("‚ö†Ô∏è Unknown message type",{type:a.type}),e({success:!1,error:"Unknown message type"})}catch(t){n.error(d.NET_E001,"Message handling error",{error:t instanceof Error?t:new Error(String(t))}),e({success:!1,error:String(t)})}return!1});
