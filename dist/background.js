import{e as l,n,s as c,E as u}from"./assets/index-CtnQ7lw9.js";l.info("üü¢ Service Worker initialized");const h="http://localhost:8000";async function g(a,m){const t=await fetch(`${h}/api/compare`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:a,providers:m,maxResults:5})});if(!t.ok)throw new Error(`API ÏöîÏ≤≠ Ïã§Ìå®: ${t.status}`);return t.json()}chrome.runtime.onMessage.addListener((a,m,t)=>{n.info("üì® Message received",{type:a.type,senderUrl:m.url,senderTab:m.tab?.id});try{if(a.type==="SAVE_PRODUCT_DATA"){const{data:r,url:o,timestamp:e}=a;c.info("üíæ Saving product data",{amount:r.amount,currency:r.currency,title:`${r.title?.substring(0,50)}...`,url:o,timestamp:new Date(e).toISOString()});const s={...r,url:o,timestamp:e,savedAt:new Date().toISOString()};return chrome.storage.local.set({currentProduct:s,lastUpdated:e},()=>{if(chrome.runtime.lastError){c.error(u.STO_E001,"Failed to save to chrome.storage.local",{error:new Error(chrome.runtime.lastError.message||"Storage error")}),t({success:!1,error:chrome.runtime.lastError.message});return}c.info("‚úÖ Data saved to chrome.storage.local"),c.debug("üìä Stored product",{amount:s.amount,currency:s.currency,title:`${s.title?.substring(0,50)}...`}),t({success:!0,message:"Data saved to storage",savedData:{amount:s.amount,currency:s.currency}})}),!0}if(a.type==="GET_PRODUCT_DATA")return c.debug("üîç GET_PRODUCT_DATA request"),chrome.storage.local.get(["currentProduct"],r=>{if(chrome.runtime.lastError){c.error(u.STO_E001,"Failed to get from chrome.storage.local",{error:new Error(chrome.runtime.lastError.message||"Storage error")}),t({success:!1,error:chrome.runtime.lastError.message,data:null});return}const o=r.currentProduct;c.debug("üì¶ Retrieved product data",{exists:!!o,amount:o?.amount,title:o?.title?`${o.title.substring(0,50)}...`:"N/A"}),t({success:!0,data:r.currentProduct||null})}),!0;if(a.type==="OPEN_AUTO_POPUP")return l.info("üé™ Opening Auto Popup (SubPopup window)"),chrome.windows.create({url:chrome.runtime.getURL("src/subpopup/index.html?auto=true"),type:"popup",width:420,height:300},r=>{chrome.runtime.lastError?(l.error(u.EXT_E002,"Failed to open Auto Popup",{error:new Error(chrome.runtime.lastError.message||"Unknown error")}),t({success:!1,error:chrome.runtime.lastError.message})):(l.info("‚úÖ Auto Popup window created",{windowId:r?.id,width:r?.width,height:r?.height}),t({success:!0,windowId:r?.id}))}),!0;if(a.type==="COMPARE_PRICES"){const{query:r,providers:o}=a;return n.info("üí∞ Price comparison request",{query:r,providers:o||"all"}),g(r,o).then(e=>{n.info("‚úÖ Price comparison completed",{success:e.success,resultCount:e.results.length,totalDuration:e.totalDuration,fromCache:e.fromCache}),t({success:!0,data:e})}).catch(e=>{n.error(u.NET_E002,"Price comparison failed",{error:e instanceof Error?e:new Error(String(e))}),t({success:!1,error:e instanceof Error?e.message:"Í∞ÄÍ≤© ÎπÑÍµê Ïã§Ìå®"})}),!0}if(a.type==="CHECK_COMPARISON_SERVER")return n.debug("üîç Checking comparison server status"),fetch(`${h}/api/health`).then(r=>r.json()).then(r=>{n.info("‚úÖ Comparison server is healthy",r),t({success:!0,data:r})}).catch(r=>{n.error(u.NET_E001,"Comparison server is down",{error:r instanceof Error?r:new Error(String(r))}),t({success:!1,error:"Í∞ÄÍ≤© ÎπÑÍµê ÏÑúÎ≤ÑÏóê Ïó∞Í≤∞Ìï† Ïàò ÏóÜÏäµÎãàÎã§"})}),!0;if(a.type==="UPDATE_PRODUCT_DATA"){const{data:r,timestamp:o,source:e}=a;return c.info("üîÑ Updating product data (dynamic content)",{amount:r.amount,currency:r.currency,title:`${r.title?.substring(0,50)}...`,source:e,timestamp:new Date(o).toISOString()}),chrome.storage.local.get(["currentProduct"],s=>{if(chrome.runtime.lastError){c.error(u.STO_E001,"Failed to get existing data",{error:new Error(chrome.runtime.lastError.message||"Storage error")}),t({success:!1,error:chrome.runtime.lastError.message});return}const d=s.currentProduct||{},i={...d,...r,url:d?.url||r.url,timestamp:d?.timestamp||o,updatedAt:new Date().toISOString(),updateSource:e};chrome.storage.local.set({currentProduct:i,lastUpdated:o},()=>{if(chrome.runtime.lastError){c.error(u.STO_E001,"Failed to update data",{error:new Error(chrome.runtime.lastError.message||"Storage error")}),t({success:!1,error:chrome.runtime.lastError.message});return}c.info("‚úÖ Product data updated",{amount:i.amount,cardBenefits:i.cardBenefits?.length||0,hasCashback:!!i.cashback}),t({success:!0,message:"Data updated from dynamic content",updatedData:{amount:i.amount,cardBenefits:i.cardBenefits}})})}),!0}n.warn("‚ö†Ô∏è Unknown message type",{type:a.type}),t({success:!1,error:"Unknown message type"})}catch(r){n.error(u.NET_E001,"Message handling error",{error:r instanceof Error?r:new Error(String(r))}),t({success:!1,error:String(r)})}return!1});
