import{n as c,E as u,s as n,e as m}from"./assets/index-CtnQ7lw9.js";const d="http://localhost:8000";async function h(t,e){const r=new AbortController,a=setTimeout(()=>r.abort(),1e4);try{const o=await fetch(`${d}/api/compare`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:t,providers:e,maxResults:5}),signal:r.signal});if(!o.ok)throw new Error(`API ÏöîÏ≤≠ Ïã§Ìå®: ${o.status}`);return o.json()}catch(o){throw o instanceof Error&&o.name==="AbortError"?new Error("ÏöîÏ≤≠ ÏãúÍ∞Ñ Ï¥àÍ≥º (10Ï¥à)"):o}finally{clearTimeout(a)}}async function g(){const t=new AbortController,e=setTimeout(()=>t.abort(),5e3);try{return(await fetch(`${d}/api/health`,{signal:t.signal})).json()}catch(r){throw r instanceof Error&&r.name==="AbortError"?new Error("ÏÑúÎ≤Ñ ÏùëÎãµ ÏãúÍ∞Ñ Ï¥àÍ≥º"):new Error("Í∞ÄÍ≤© ÎπÑÍµê ÏÑúÎ≤ÑÏóê Ïó∞Í≤∞Ìï† Ïàò ÏóÜÏäµÎãàÎã§")}finally{clearTimeout(e)}}function f(t,e){const{data:r,url:a,timestamp:o}=t;n.info("üíæ Saving product data",{amount:r.amount,currency:r.currency,title:`${r.title?.substring(0,50)}...`,url:a,timestamp:new Date(o).toISOString()});const s={...r,url:a,timestamp:o,savedAt:new Date().toISOString()};return chrome.storage.local.set({currentProduct:s,lastUpdated:o},()=>{if(chrome.runtime.lastError){n.error(u.STO_E001,"Failed to save to chrome.storage.local",{error:new Error(chrome.runtime.lastError.message||"Storage error")}),e({success:!1,error:chrome.runtime.lastError.message});return}n.info("‚úÖ Data saved to chrome.storage.local"),n.debug("üìä Stored product",{amount:s.amount,currency:s.currency,title:`${s.title?.substring(0,50)}...`}),e({success:!0,message:"Data saved to storage",savedData:{amount:s.amount,currency:s.currency}})}),!0}function E(t){return n.debug("üîç GET_PRODUCT_DATA request"),chrome.storage.local.get(["currentProduct"],e=>{if(chrome.runtime.lastError){n.error(u.STO_E001,"Failed to get from chrome.storage.local",{error:new Error(chrome.runtime.lastError.message||"Storage error")}),t({success:!1,error:chrome.runtime.lastError.message,data:null});return}const r=e.currentProduct;n.debug("üì¶ Retrieved product data",{exists:!!r,amount:r?.amount,title:r?.title?`${r.title.substring(0,50)}...`:"N/A"}),t({success:!0,data:e.currentProduct||null})}),!0}function p(t){return m.info("üé™ Opening Auto Popup (SubPopup window)"),chrome.windows.create({url:chrome.runtime.getURL("src/subpopup/index.html?auto=true"),type:"popup",width:420,height:300},e=>{chrome.runtime.lastError?(m.error(u.EXT_E002,"Failed to open Auto Popup",{error:new Error(chrome.runtime.lastError.message||"Unknown error")}),t({success:!1,error:chrome.runtime.lastError.message})):(m.info("‚úÖ Auto Popup window created",{windowId:e?.id,width:e?.width,height:e?.height}),t({success:!0,windowId:e?.id}))}),!0}function w(t,e){const{query:r,providers:a}=t;return c.info("üí∞ Price comparison request",{query:r,providers:a||"all"}),h(r,a).then(o=>{c.info("‚úÖ Price comparison completed",{success:o.success,resultCount:o.results.length,totalDuration:o.totalDuration,fromCache:o.fromCache}),e({success:!0,data:o})}).catch(o=>{c.error(u.NET_E002,"Price comparison failed",{error:o instanceof Error?o:new Error(String(o))}),e({success:!1,error:o instanceof Error?o.message:"Í∞ÄÍ≤© ÎπÑÍµê Ïã§Ìå®"})}),!0}function P(t){return c.debug("üîç Checking comparison server status"),g().then(e=>{c.info("‚úÖ Comparison server is healthy",e),t({success:!0,data:e})}).catch(e=>{const r=e instanceof Error?e.message:"Í∞ÄÍ≤© ÎπÑÍµê ÏÑúÎ≤ÑÏóê Ïó∞Í≤∞Ìï† Ïàò ÏóÜÏäµÎãàÎã§";c.error(u.NET_E001,"Comparison server is down",{error:e instanceof Error?e:new Error(String(e))}),t({success:!1,error:r})}),!0}function S(t,e){const{data:r,timestamp:a,source:o}=t;return n.info("üîÑ Updating product data (dynamic content)",{amount:r.amount,currency:r.currency,title:`${r.title?.substring(0,50)}...`,source:o,timestamp:new Date(a).toISOString()}),chrome.storage.local.get(["currentProduct"],s=>{if(chrome.runtime.lastError){n.error(u.STO_E001,"Failed to get existing data",{error:new Error(chrome.runtime.lastError.message||"Storage error")}),e({success:!1,error:chrome.runtime.lastError.message});return}const l=s.currentProduct||{},i={...l,...r,url:l?.url||r.url,timestamp:l?.timestamp||a,updatedAt:new Date().toISOString(),updateSource:o};chrome.storage.local.set({currentProduct:i,lastUpdated:a},()=>{if(chrome.runtime.lastError){n.error(u.STO_E001,"Failed to update data",{error:new Error(chrome.runtime.lastError.message||"Storage error")}),e({success:!1,error:chrome.runtime.lastError.message});return}n.info("‚úÖ Product data updated",{amount:i.amount,cardBenefits:i.cardBenefits?.length||0,hasCashback:!!i.cashback}),e({success:!0,message:"Data updated from dynamic content",updatedData:{amount:i.amount,cardBenefits:i.cardBenefits}})})}),!0}function y(){chrome.runtime.onMessage.addListener((t,e,r)=>{c.info("üì® Message received",{type:t.type,senderUrl:e.url,senderTab:e.tab?.id});try{switch(t.type){case"SAVE_PRODUCT_DATA":return f(t,r);case"GET_PRODUCT_DATA":return E(r);case"OPEN_AUTO_POPUP":return p(r);case"COMPARE_PRICES":return w(t,r);case"CHECK_COMPARISON_SERVER":return P(r);case"UPDATE_PRODUCT_DATA":return S(t,r);default:return c.warn("‚ö†Ô∏è Unknown message type",{type:t.type}),r({success:!1,error:"Unknown message type"}),!1}}catch(a){return c.error(u.NET_E001,"Message handling error",{error:a instanceof Error?a:new Error(String(a))}),r({success:!1,error:String(a)}),!1}})}m.info("üü¢ Service Worker initialized");y();
