import{n as m,E as d,s as i,e as g}from"./assets/index-CtnQ7lw9.js";import{T as y}from"./assets/tokenManager-BtvXDoI5.js";var D={};const C=typeof process<"u"&&D?.VITE_BACKEND_URL||"http://localhost:8000",A=String(C).replace(/\/$/,"");async function P(t,e,r,a,s){const n=new AbortController,u=setTimeout(()=>n.abort(),15e3),o=String(t??"").trim(),E=`${A}/api/v1/price/search`,p={product_name:o};r&&(p.current_price=r),a&&(p.current_url=a),s&&s.length>0&&(p.selected_options=s);const _=Date.now();console.info("ðŸ”— [BACKEND] Fetching price comparison:",{url:E,body:p,providers:e||"all"});try{const c=await fetch(E,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(p),signal:n.signal});if(console.info("ðŸ“¡ [BACKEND] Response status:",c.status),!c.ok)throw c.status===404?new Error("ìƒí’ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (404)"):c.status===400?new Error("ìš”ì²­ íŒŒë¼ë¯¸í„°ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. (400)"):new Error(`API ìš”ì²­ ì‹¤íŒ¨: ${c.status}`);const f=await c.json();if(console.info("âœ… [BACKEND] Response data:",f),f.status!=="success"||!f.data)throw new Error(f.message||"ê²€ìƒ‰ ì‹¤íŒ¨");const w=Date.now()-_,h=f.data,S=Array.isArray(h.top_prices)?h.top_prices.filter(l=>l&&typeof l.price=="number").map(l=>({id:`${l.rank}`,name:l.mall,price:l.price,currency:"KRW",url:l.link||"",isFreeShipping:!!l.free_shipping,deliveryInfo:l.delivery})):[];return{success:!0,query:o,results:[{provider:"danawa",success:!0,products:S,duration:w}],totalDuration:w,fromCache:!1,is_cheaper:h.is_cheaper,price_diff:h.price_diff,lowest_price:h.lowest_price,mall:h.mall,link:h.link}}catch(c){throw console.error("âŒ [BACKEND] Fetch error:",c),c instanceof Error&&c.name==="AbortError"?new Error("ìš”ì²­ ì‹œê°„ ì´ˆê³¼ (15ì´ˆ)"):c}finally{clearTimeout(u)}}async function T(){const t=new AbortController,e=setTimeout(()=>t.abort(),5e3);try{const r=await fetch(`${A}/health`,{signal:t.signal});let a=null;try{a=await r.json()}catch{}return{ok:r.ok,status:r.status,data:a}}catch(r){throw r instanceof Error&&r.name==="AbortError"?new Error("ì„œë²„ ì‘ë‹µ ì‹œê°„ ì´ˆê³¼"):new Error("ê°€ê²© ë¹„êµ ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤")}finally{clearTimeout(e)}}function O(t,e){const{data:r,url:a,timestamp:s}=t;i.info("ðŸ’¾ Saving product data",{amount:r.amount,currency:r.currency,title:`${r.title?.substring(0,50)}...`,url:a,timestamp:new Date(s).toISOString()});const n={...r,url:a,timestamp:s,savedAt:new Date().toISOString()};return chrome.storage.local.set({currentProduct:n,lastUpdated:s},()=>{if(chrome.runtime.lastError){i.error(d.STO_E001,"Failed to save to chrome.storage.local",{error:new Error(chrome.runtime.lastError.message||"Storage error")}),e({success:!1,error:chrome.runtime.lastError.message});return}i.info("âœ… Data saved to chrome.storage.local"),i.debug("ðŸ“Š Stored product",{amount:n.amount,currency:n.currency,title:`${n.title?.substring(0,50)}...`}),e({success:!0,message:"Data saved to storage",savedData:{amount:n.amount,currency:n.currency}})}),!0}function v(t){return i.debug("ðŸ” GET_PRODUCT_DATA request"),chrome.storage.local.get(["currentProduct"],e=>{if(chrome.runtime.lastError){i.error(d.STO_E001,"Failed to get from chrome.storage.local",{error:new Error(chrome.runtime.lastError.message||"Storage error")}),t({success:!1,error:chrome.runtime.lastError.message,data:null});return}const r=e.currentProduct;i.debug("ðŸ“¦ Retrieved product data",{exists:!!r,amount:r?.amount,title:r?.title?`${r.title.substring(0,50)}...`:"N/A"}),t({success:!0,data:e.currentProduct||null})}),!0}function k(t){return g.info("ðŸŽª Opening Auto Popup (SubPopup window)"),chrome.windows.create({url:chrome.runtime.getURL("src/subpopup/index.html?auto=true"),type:"popup",width:420,height:300},e=>{chrome.runtime.lastError?(g.error(d.EXT_E002,"Failed to open Auto Popup",{error:new Error(chrome.runtime.lastError.message||"Unknown error")}),t({success:!1,error:chrome.runtime.lastError.message})):(g.info("âœ… Auto Popup window created",{windowId:e?.id,width:e?.width,height:e?.height}),t({success:!0,windowId:e?.id}))}),!0}function b(t,e){const{query:r,providers:a,currentPrice:s,currentUrl:n,selectedOptions:u}=t;return m.info("ðŸ’° [BACKEND] Price comparison request received",{query:r,providers:a||"all",currentPrice:s,currentUrl:n,selectedOptionsCount:u?.length||0,timestamp:new Date().toISOString()}),P(r,a,s,n,u).then(o=>{m.info("âœ… [BACKEND] Price comparison completed",{success:o.success,resultCount:o.results.length,totalDuration:o.totalDuration,fromCache:o.fromCache,query:r}),e({success:!0,data:o})}).catch(o=>{m.error(d.NET_E002,"[BACKEND] Price comparison failed",{error:o instanceof Error?o:new Error(String(o)),data:{query:r}}),e({success:!1,error:o instanceof Error?o.message:"ê°€ê²© ë¹„êµ ì‹¤íŒ¨"})}),!0}function N(t){return m.debug("ðŸ” [BACKEND] Checking comparison server status"),T().then(e=>{m.info("âœ… [BACKEND] Comparison server is healthy",e),t({success:!0,data:e})}).catch(e=>{const r=e instanceof Error?e.message:"ê°€ê²© ë¹„êµ ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤";m.error(d.NET_E001,"âŒ [BACKEND] Comparison server is down",{error:e instanceof Error?e:new Error(String(e))}),t({success:!1,error:r})}),!0}function U(t,e){const{data:r,timestamp:a,source:s}=t;return i.info("ðŸ”„ Updating product data (dynamic content)",{amount:r.amount,currency:r.currency,title:`${r.title?.substring(0,50)}...`,source:s,timestamp:new Date(a).toISOString()}),chrome.storage.local.get(["currentProduct"],n=>{if(chrome.runtime.lastError){i.error(d.STO_E001,"Failed to get existing data",{error:new Error(chrome.runtime.lastError.message||"Storage error")}),e({success:!1,error:chrome.runtime.lastError.message});return}const u=n.currentProduct||{},o={...u,...r,url:u?.url||r.url,timestamp:u?.timestamp||a,updatedAt:new Date().toISOString(),updateSource:s};chrome.storage.local.set({currentProduct:o,lastUpdated:a},()=>{if(chrome.runtime.lastError){i.error(d.STO_E001,"Failed to update data",{error:new Error(chrome.runtime.lastError.message||"Storage error")}),e({success:!1,error:chrome.runtime.lastError.message});return}i.info("âœ… Product data updated",{amount:o.amount,cardBenefits:o.cardBenefits?.length||0,hasCashback:!!o.cashback}),e({success:!0,message:"Data updated from dynamic content",updatedData:{amount:o.amount,cardBenefits:o.cardBenefits}})})}),!0}function B(){chrome.runtime.onMessage.addListener((t,e,r)=>{m.info("ðŸ“¨ Message received",{type:t.type,senderUrl:e.url,senderTab:e.tab?.id});try{switch(t.type){case"SAVE_PRODUCT_DATA":return O(t,r);case"GET_PRODUCT_DATA":return v(r);case"OPEN_AUTO_POPUP":return k(r);case"COMPARE_PRICES":return b(t,r);case"CHECK_COMPARISON_SERVER":return N(r);case"UPDATE_PRODUCT_DATA":return U(t,r);default:return m.warn("âš ï¸ Unknown message type",{type:t.type}),r({success:!1,error:"Unknown message type"}),!1}}catch(a){return m.error(d.NET_E001,"Message handling error",{error:a instanceof Error?a:new Error(String(a))}),r({success:!1,error:String(a)}),!1}})}const I=()=>{chrome.runtime.onMessage.addListener((t,e,r)=>{if(t.type==="EXTENSION_AUTH_TOKEN"){const{accessToken:a,refreshToken:s,expiresIn:n}=t;if(a&&s&&n){const u={accessToken:a,refreshToken:s,expiresAt:Date.now()+n*1e3};return y.saveToken(u).then(()=>{console.warn("[Background] Auth token saved"),r({success:!0})}).catch(o=>{console.error("[Background] Failed to save token:",o),r({success:!1,error:o.message})}),!0}}return!1})};g.info("ðŸŸ¢ Service Worker initialized");B();I();
