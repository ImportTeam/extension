console.log("[Background] üü¢ Service Worker initialized");const i="http://localhost:3001";async function l(o,u){const e=await fetch(`${i}/api/compare`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:o,providers:u,maxResults:5})});if(!e.ok)throw new Error(`API ÏöîÏ≤≠ Ïã§Ìå®: ${e.status}`);return e.json()}chrome.runtime.onMessage.addListener((o,u,e)=>{console.log("[Background] üì® Message received",{type:o.type,senderUrl:u.url,senderTab:u.tab?.id});try{if(o.type==="SAVE_PRODUCT_DATA"){const{data:t,url:c,timestamp:r}=o;console.log("[Background] üíæ Saving product data:",{amount:t.amount,currency:t.currency,title:t.title?.substring(0,50)+"...",url:c,timestamp:new Date(r).toISOString()});const a={...t,url:c,timestamp:r,savedAt:new Date().toISOString()};return chrome.storage.local.set({currentProduct:a,lastUpdated:r},()=>{console.log("[Background] ‚úÖ Data saved to chrome.storage.local"),console.log("[Background] üìä Stored product:",{amount:a.amount,currency:a.currency,title:a.title?.substring(0,50)+"..."}),e({success:!0,message:"Data saved to storage",savedData:{amount:a.amount,currency:a.currency}})}),!0}if(o.type==="GET_PRODUCT_DATA")return console.log("[Background] üîç GET_PRODUCT_DATA request"),chrome.storage.local.get(["currentProduct"],t=>{const c=t.currentProduct;console.log("[Background] üì¶ Retrieved product data:",{exists:!!c,amount:c?.amount,title:c?.title?.substring(0,50)+"..."}),e({success:!0,data:t.currentProduct||null})}),!0;if(o.type==="OPEN_AUTO_POPUP")return console.log("[Background] üé™ Opening Auto Popup (SubPopup window)"),chrome.windows.create({url:chrome.runtime.getURL("src/subpopup/index.html?auto=true"),type:"popup",width:420,height:300},t=>{chrome.runtime.lastError?(console.error("[Background] ‚ùå Failed to open Auto Popup:",chrome.runtime.lastError),e({success:!1,error:chrome.runtime.lastError.message})):(console.log("[Background] ‚úÖ Auto Popup window created:",{windowId:t?.id,width:t?.width,height:t?.height}),e({success:!0,windowId:t?.id}))}),!0;if(o.type==="COMPARE_PRICES"){const{query:t,providers:c}=o;return console.log("[Background] üí∞ Price comparison request:",{query:t,providers:c||"all"}),l(t,c).then(r=>{console.log("[Background] ‚úÖ Price comparison completed:",{success:r.success,resultCount:r.results.length,totalDuration:r.totalDuration,fromCache:r.fromCache}),e({success:!0,data:r})}).catch(r=>{console.error("[Background] ‚ùå Price comparison failed:",r),e({success:!1,error:r instanceof Error?r.message:"Í∞ÄÍ≤© ÎπÑÍµê Ïã§Ìå®"})}),!0}if(o.type==="CHECK_COMPARISON_SERVER")return console.log("[Background] üîç Checking comparison server status"),fetch(`${i}/api/health`).then(t=>t.json()).then(t=>{console.log("[Background] ‚úÖ Comparison server is healthy:",t),e({success:!0,data:t})}).catch(t=>{console.error("[Background] ‚ùå Comparison server is down:",t),e({success:!1,error:"Í∞ÄÍ≤© ÎπÑÍµê ÏÑúÎ≤ÑÏóê Ïó∞Í≤∞Ìï† Ïàò ÏóÜÏäµÎãàÎã§"})}),!0;if(o.type==="UPDATE_PRODUCT_DATA"){const{data:t,timestamp:c,source:r}=o;return console.log("[Background] üîÑ Updating product data (dynamic content):",{amount:t.amount,currency:t.currency,title:t.title?.substring(0,50)+"...",source:r,timestamp:new Date(c).toISOString()}),chrome.storage.local.get(["currentProduct"],a=>{const s=a.currentProduct||{},n={...s,...t,url:s?.url||t.url,timestamp:s?.timestamp||c,updatedAt:new Date().toISOString(),updateSource:r};chrome.storage.local.set({currentProduct:n,lastUpdated:c},()=>{console.log("[Background] ‚úÖ Product data updated:",{amount:n.amount,cardBenefits:n.cardBenefits?.length||0,hasCashback:!!n.cashback}),e({success:!0,message:"Data updated from dynamic content",updatedData:{amount:n.amount,cardBenefits:n.cardBenefits}})})}),!0}console.warn("[Background] ‚ö†Ô∏è Unknown message type:",o.type),e({success:!1,error:"Unknown message type"})}catch(t){console.error("[Background] ‚ùå Error:",t),e({success:!1,error:String(t)})}return!1});
