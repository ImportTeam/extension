import{n as s,E as u,s as c,e as l}from"./assets/index-CtnQ7lw9.js";const d="http://localhost:8000";async function h(o,e){const r=new AbortController,a=setTimeout(()=>r.abort(),1e4);console.info("üîó [BACKEND] Fetching price comparison:",{url:`${d}/api/compare`,query:o,providers:e||"all"});try{const t=await fetch(`${d}/api/compare`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:o,providers:e,maxResults:5}),signal:r.signal});if(console.info("üì° [BACKEND] Response status:",t.status),!t.ok)throw new Error(`API ÏöîÏ≤≠ Ïã§Ìå®: ${t.status}`);const n=await t.json();return console.info("‚úÖ [BACKEND] Response data:",n),n}catch(t){throw console.error("‚ùå [BACKEND] Fetch error:",t),t instanceof Error&&t.name==="AbortError"?new Error("ÏöîÏ≤≠ ÏãúÍ∞Ñ Ï¥àÍ≥º (10Ï¥à)"):t}finally{clearTimeout(a)}}async function g(){const o=new AbortController,e=setTimeout(()=>o.abort(),5e3);try{return(await fetch(`${d}/api/health`,{signal:o.signal})).json()}catch(r){throw r instanceof Error&&r.name==="AbortError"?new Error("ÏÑúÎ≤Ñ ÏùëÎãµ ÏãúÍ∞Ñ Ï¥àÍ≥º"):new Error("Í∞ÄÍ≤© ÎπÑÍµê ÏÑúÎ≤ÑÏóê Ïó∞Í≤∞Ìï† Ïàò ÏóÜÏäµÎãàÎã§")}finally{clearTimeout(e)}}function E(o,e){const{data:r,url:a,timestamp:t}=o;c.info("üíæ Saving product data",{amount:r.amount,currency:r.currency,title:`${r.title?.substring(0,50)}...`,url:a,timestamp:new Date(t).toISOString()});const n={...r,url:a,timestamp:t,savedAt:new Date().toISOString()};return chrome.storage.local.set({currentProduct:n,lastUpdated:t},()=>{if(chrome.runtime.lastError){c.error(u.STO_E001,"Failed to save to chrome.storage.local",{error:new Error(chrome.runtime.lastError.message||"Storage error")}),e({success:!1,error:chrome.runtime.lastError.message});return}c.info("‚úÖ Data saved to chrome.storage.local"),c.debug("üìä Stored product",{amount:n.amount,currency:n.currency,title:`${n.title?.substring(0,50)}...`}),e({success:!0,message:"Data saved to storage",savedData:{amount:n.amount,currency:n.currency}})}),!0}function f(o){return c.debug("üîç GET_PRODUCT_DATA request"),chrome.storage.local.get(["currentProduct"],e=>{if(chrome.runtime.lastError){c.error(u.STO_E001,"Failed to get from chrome.storage.local",{error:new Error(chrome.runtime.lastError.message||"Storage error")}),o({success:!1,error:chrome.runtime.lastError.message,data:null});return}const r=e.currentProduct;c.debug("üì¶ Retrieved product data",{exists:!!r,amount:r?.amount,title:r?.title?`${r.title.substring(0,50)}...`:"N/A"}),o({success:!0,data:e.currentProduct||null})}),!0}function p(o){return l.info("üé™ Opening Auto Popup (SubPopup window)"),chrome.windows.create({url:chrome.runtime.getURL("src/subpopup/index.html?auto=true"),type:"popup",width:420,height:300},e=>{chrome.runtime.lastError?(l.error(u.EXT_E002,"Failed to open Auto Popup",{error:new Error(chrome.runtime.lastError.message||"Unknown error")}),o({success:!1,error:chrome.runtime.lastError.message})):(l.info("‚úÖ Auto Popup window created",{windowId:e?.id,width:e?.width,height:e?.height}),o({success:!0,windowId:e?.id}))}),!0}function w(o,e){const{query:r,providers:a}=o;return s.info("üí∞ [BACKEND] Price comparison request received",{query:r,providers:a||"all",timestamp:new Date().toISOString()}),h(r,a).then(t=>{s.info("‚úÖ [BACKEND] Price comparison completed",{success:t.success,resultCount:t.results.length,totalDuration:t.totalDuration,fromCache:t.fromCache,query:r}),e({success:!0,data:t})}).catch(t=>{s.error(u.NET_E002,"[BACKEND] Price comparison failed",{error:t instanceof Error?t:new Error(String(t)),query:r}),e({success:!1,error:t instanceof Error?t.message:"Í∞ÄÍ≤© ÎπÑÍµê Ïã§Ìå®"})}),!0}function S(o){return s.debug("üîç [BACKEND] Checking comparison server status"),g().then(e=>{s.info("‚úÖ [BACKEND] Comparison server is healthy",e),o({success:!0,data:e})}).catch(e=>{const r=e instanceof Error?e.message:"Í∞ÄÍ≤© ÎπÑÍµê ÏÑúÎ≤ÑÏóê Ïó∞Í≤∞Ìï† Ïàò ÏóÜÏäµÎãàÎã§";s.error(u.NET_E001,"‚ùå [BACKEND] Comparison server is down",{error:e instanceof Error?e:new Error(String(e))}),o({success:!1,error:r})}),!0}function D(o,e){const{data:r,timestamp:a,source:t}=o;return c.info("üîÑ Updating product data (dynamic content)",{amount:r.amount,currency:r.currency,title:`${r.title?.substring(0,50)}...`,source:t,timestamp:new Date(a).toISOString()}),chrome.storage.local.get(["currentProduct"],n=>{if(chrome.runtime.lastError){c.error(u.STO_E001,"Failed to get existing data",{error:new Error(chrome.runtime.lastError.message||"Storage error")}),e({success:!1,error:chrome.runtime.lastError.message});return}const m=n.currentProduct||{},i={...m,...r,url:m?.url||r.url,timestamp:m?.timestamp||a,updatedAt:new Date().toISOString(),updateSource:t};chrome.storage.local.set({currentProduct:i,lastUpdated:a},()=>{if(chrome.runtime.lastError){c.error(u.STO_E001,"Failed to update data",{error:new Error(chrome.runtime.lastError.message||"Storage error")}),e({success:!1,error:chrome.runtime.lastError.message});return}c.info("‚úÖ Product data updated",{amount:i.amount,cardBenefits:i.cardBenefits?.length||0,hasCashback:!!i.cashback}),e({success:!0,message:"Data updated from dynamic content",updatedData:{amount:i.amount,cardBenefits:i.cardBenefits}})})}),!0}function P(){chrome.runtime.onMessage.addListener((o,e,r)=>{s.info("üì® Message received",{type:o.type,senderUrl:e.url,senderTab:e.tab?.id});try{switch(o.type){case"SAVE_PRODUCT_DATA":return E(o,r);case"GET_PRODUCT_DATA":return f(r);case"OPEN_AUTO_POPUP":return p(r);case"COMPARE_PRICES":return w(o,r);case"CHECK_COMPARISON_SERVER":return S(r);case"UPDATE_PRODUCT_DATA":return D(o,r);default:return s.warn("‚ö†Ô∏è Unknown message type",{type:o.type}),r({success:!1,error:"Unknown message type"}),!1}}catch(a){return s.error(u.NET_E001,"Message handling error",{error:a instanceof Error?a:new Error(String(a))}),r({success:!1,error:String(a)}),!1}})}l.info("üü¢ Service Worker initialized");P();
