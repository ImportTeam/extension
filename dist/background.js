import{n as m,E as d,s as i,e as E}from"./assets/index-CtnQ7lw9.js";var y={};const A=typeof process<"u"&&y?.VITE_BACKEND_URL||"http://localhost:8000",w=String(A).replace(/\/$/,"");async function D(t,e,r,o){const s=new AbortController,n=setTimeout(()=>s.abort(),15e3),a=String(t??"").trim(),u=`${w}/api/v1/price/search`,f={product_name:a};r&&(f.current_price=r),o&&(f.current_url=o);const S=Date.now();console.info("üîó [BACKEND] Fetching price comparison:",{url:u,body:f,providers:e||"all"});try{const c=await fetch(u,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(f),signal:s.signal});if(console.info("üì° [BACKEND] Response status:",c.status),!c.ok)throw c.status===404?new Error("ÏÉÅÌíàÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§. (404)"):c.status===400?new Error("ÏöîÏ≤≠ ÌååÎùºÎØ∏ÌÑ∞Í∞Ä Ïò¨Î∞îÎ•¥ÏßÄ ÏïäÏäµÎãàÎã§. (400)"):new Error(`API ÏöîÏ≤≠ Ïã§Ìå®: ${c.status}`);const h=await c.json();if(console.info("‚úÖ [BACKEND] Response data:",h),h.status!=="success"||!h.data)throw new Error(h.message||"Í≤ÄÏÉâ Ïã§Ìå®");const g=Date.now()-S,p=h.data,_=Array.isArray(p.top_prices)?p.top_prices.filter(l=>l&&typeof l.price=="number").map(l=>({id:`${l.rank}`,name:l.mall,price:l.price,currency:"KRW",url:l.link||"",isFreeShipping:!!l.free_shipping,deliveryInfo:l.delivery})):[];return{success:!0,query:a,results:[{provider:"danawa",success:!0,products:_,duration:g}],totalDuration:g,fromCache:!1,is_cheaper:p.is_cheaper,price_diff:p.price_diff,lowest_price:p.lowest_price,mall:p.mall,link:p.link}}catch(c){throw console.error("‚ùå [BACKEND] Fetch error:",c),c instanceof Error&&c.name==="AbortError"?new Error("ÏöîÏ≤≠ ÏãúÍ∞Ñ Ï¥àÍ≥º (15Ï¥à)"):c}finally{clearTimeout(n)}}async function C(){const t=new AbortController,e=setTimeout(()=>t.abort(),5e3);try{const r=await fetch(`${w}/health`,{signal:t.signal});let o=null;try{o=await r.json()}catch{}return{ok:r.ok,status:r.status,data:o}}catch(r){throw r instanceof Error&&r.name==="AbortError"?new Error("ÏÑúÎ≤Ñ ÏùëÎãµ ÏãúÍ∞Ñ Ï¥àÍ≥º"):new Error("Í∞ÄÍ≤© ÎπÑÍµê ÏÑúÎ≤ÑÏóê Ïó∞Í≤∞Ìï† Ïàò ÏóÜÏäµÎãàÎã§")}finally{clearTimeout(e)}}function P(t,e){const{data:r,url:o,timestamp:s}=t;i.info("üíæ Saving product data",{amount:r.amount,currency:r.currency,title:`${r.title?.substring(0,50)}...`,url:o,timestamp:new Date(s).toISOString()});const n={...r,url:o,timestamp:s,savedAt:new Date().toISOString()};return chrome.storage.local.set({currentProduct:n,lastUpdated:s},()=>{if(chrome.runtime.lastError){i.error(d.STO_E001,"Failed to save to chrome.storage.local",{error:new Error(chrome.runtime.lastError.message||"Storage error")}),e({success:!1,error:chrome.runtime.lastError.message});return}i.info("‚úÖ Data saved to chrome.storage.local"),i.debug("üìä Stored product",{amount:n.amount,currency:n.currency,title:`${n.title?.substring(0,50)}...`}),e({success:!0,message:"Data saved to storage",savedData:{amount:n.amount,currency:n.currency}})}),!0}function T(t){return i.debug("üîç GET_PRODUCT_DATA request"),chrome.storage.local.get(["currentProduct"],e=>{if(chrome.runtime.lastError){i.error(d.STO_E001,"Failed to get from chrome.storage.local",{error:new Error(chrome.runtime.lastError.message||"Storage error")}),t({success:!1,error:chrome.runtime.lastError.message,data:null});return}const r=e.currentProduct;i.debug("üì¶ Retrieved product data",{exists:!!r,amount:r?.amount,title:r?.title?`${r.title.substring(0,50)}...`:"N/A"}),t({success:!0,data:e.currentProduct||null})}),!0}function O(t){return E.info("üé™ Opening Auto Popup (SubPopup window)"),chrome.windows.create({url:chrome.runtime.getURL("src/subpopup/index.html?auto=true"),type:"popup",width:420,height:300},e=>{chrome.runtime.lastError?(E.error(d.EXT_E002,"Failed to open Auto Popup",{error:new Error(chrome.runtime.lastError.message||"Unknown error")}),t({success:!1,error:chrome.runtime.lastError.message})):(E.info("‚úÖ Auto Popup window created",{windowId:e?.id,width:e?.width,height:e?.height}),t({success:!0,windowId:e?.id}))}),!0}function v(t,e){const{query:r,providers:o,currentPrice:s,currentUrl:n}=t;return m.info("üí∞ [BACKEND] Price comparison request received",{query:r,providers:o||"all",currentPrice:s,currentUrl:n,timestamp:new Date().toISOString()}),D(r,o,s,n).then(a=>{m.info("‚úÖ [BACKEND] Price comparison completed",{success:a.success,resultCount:a.results.length,totalDuration:a.totalDuration,fromCache:a.fromCache,query:r}),e({success:!0,data:a})}).catch(a=>{m.error(d.NET_E002,"[BACKEND] Price comparison failed",{error:a instanceof Error?a:new Error(String(a)),data:{query:r}}),e({success:!1,error:a instanceof Error?a.message:"Í∞ÄÍ≤© ÎπÑÍµê Ïã§Ìå®"})}),!0}function b(t){return m.debug("üîç [BACKEND] Checking comparison server status"),C().then(e=>{m.info("‚úÖ [BACKEND] Comparison server is healthy",e),t({success:!0,data:e})}).catch(e=>{const r=e instanceof Error?e.message:"Í∞ÄÍ≤© ÎπÑÍµê ÏÑúÎ≤ÑÏóê Ïó∞Í≤∞Ìï† Ïàò ÏóÜÏäµÎãàÎã§";m.error(d.NET_E001,"‚ùå [BACKEND] Comparison server is down",{error:e instanceof Error?e:new Error(String(e))}),t({success:!1,error:r})}),!0}function N(t,e){const{data:r,timestamp:o,source:s}=t;return i.info("üîÑ Updating product data (dynamic content)",{amount:r.amount,currency:r.currency,title:`${r.title?.substring(0,50)}...`,source:s,timestamp:new Date(o).toISOString()}),chrome.storage.local.get(["currentProduct"],n=>{if(chrome.runtime.lastError){i.error(d.STO_E001,"Failed to get existing data",{error:new Error(chrome.runtime.lastError.message||"Storage error")}),e({success:!1,error:chrome.runtime.lastError.message});return}const a=n.currentProduct||{},u={...a,...r,url:a?.url||r.url,timestamp:a?.timestamp||o,updatedAt:new Date().toISOString(),updateSource:s};chrome.storage.local.set({currentProduct:u,lastUpdated:o},()=>{if(chrome.runtime.lastError){i.error(d.STO_E001,"Failed to update data",{error:new Error(chrome.runtime.lastError.message||"Storage error")}),e({success:!1,error:chrome.runtime.lastError.message});return}i.info("‚úÖ Product data updated",{amount:u.amount,cardBenefits:u.cardBenefits?.length||0,hasCashback:!!u.cashback}),e({success:!0,message:"Data updated from dynamic content",updatedData:{amount:u.amount,cardBenefits:u.cardBenefits}})})}),!0}function U(){chrome.runtime.onMessage.addListener((t,e,r)=>{m.info("üì® Message received",{type:t.type,senderUrl:e.url,senderTab:e.tab?.id});try{switch(t.type){case"SAVE_PRODUCT_DATA":return P(t,r);case"GET_PRODUCT_DATA":return T(r);case"OPEN_AUTO_POPUP":return O(r);case"COMPARE_PRICES":return v(t,r);case"CHECK_COMPARISON_SERVER":return b(r);case"UPDATE_PRODUCT_DATA":return N(t,r);default:return m.warn("‚ö†Ô∏è Unknown message type",{type:t.type}),r({success:!1,error:"Unknown message type"}),!1}}catch(o){return m.error(d.NET_E001,"Message handling error",{error:o instanceof Error?o:new Error(String(o))}),r({success:!1,error:String(o)}),!1}})}E.info("üü¢ Service Worker initialized");U();
