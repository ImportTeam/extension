# 파싱 제약사항 문서

## 개요
Content Script는 보안상 **iframe 내부 콘텐츠에 접근할 수 없습니다.** 따라서 페이지 로드 시점에 정적으로 렌더링된 데이터만 파싱 가능합니다.

---

## Coupang 상품 페이지의 경우

### ✅ 파싱 가능한 데이터 (정적)

| 섹션 | 위치 | 상태 | 파싱 | 예시 |
|------|------|------|------|------|
| **상품명** | 페이지 상단 | 초기 로드 시 존재 | ✅ | "빅트랙 2024 브이북 15.6..." |
| **판매가** | 가격 영역 | 초기 로드 시 존재 | ✅ | 338,660 KRW |
| **와우할인가** | 가격 영역 | 초기 로드 시 존재 | ✅ | 321,720 KRW |
| **배송정보** | 상품상세 | 초기 로드 시 존재 | ✅ | "무료배송" |
| **카드 혜택** | `.ccid-benefit-badge` | 초기 로드 시 존재 | ✅ | "신한, 우리 외... 최대 1%" |

### ❌ 파싱 불가능한 데이터 (동적/iframe)

| 섹션 | 위치 | 이유 | 상태 |
|------|------|------|------|
| **기프트카드 할인** | iframe 내부 | 사용자 클릭 후 로드 | ❌ |
| **카드사별 상세 혜택** | iframe 내부 | "카드 혜택 상세보기" 클릭 필요 | ❌ |
| **쿠팡캐시 상세** | iframe 내부 | "혜택보기" 클릭 필요 | ❌ |

---

## 아키텍처 제약사항

### 1️⃣ Same-Origin Policy (동일 출처 정책)
```
Content Script (coupang.com)
  ├─ Main Document (coupang.com) ✅ 접근 가능
  └─ iframe (payco.coupang.com) ❌ 접근 불가
```

### 2️⃣ iframe 로드 타이밍
```
DOMContentLoaded 이벤트
  ↓
  ├─ 정적 DOM 파싱 ✅ (카드 혜택, 기본가격)
  └─ iframe 로드 ⏳ (아직 렌더링 중)
       ↓
       ├─ 사용자 클릭 필요 (기프트카드 60%)
       └─ Content Script는 접근 불가 ❌
```

### 3️⃣ Content Script의 한계
- ✅ `window.top`에서만 실행 가능 (iframe 차단)
- ✅ 페이지의 DOM에 접근 가능
- ❌ 다른 출처의 iframe 콘텐츠 접근 불가
- ❌ iframe 내부 JavaScript 실행 불가

---

## 파싱 데이터 예시

### 현재 추출 데이터
```json
{
  "title": "빅트랙 2024 브이북 15.6 셀러론 인텔 11세대스페이스 실버 · 512GB · 8GB · WIN11 Home · VIC-LPTP01",
  "originalPrice": 338660,
  "discountPrice": 321720,
  "amount": 321720,
  "currency": "KRW",
  "shippingInfo": "무료배송",
  "cardBenefits": [
    {
      "cardName": "신한카드, 우리카드, BC카드 외",
      "benefit": "최대 1% 즉시할인 (와우전용)",
      "rate": 1
    }
  ],
  "metadata": {
    "source": "coupang-dom",
    "parseTime": 1762164801160
  }
}
```

### 접근 불가능한 데이터
```json
{
  "giftCardDiscount": "60%",           // ❌ iframe 내부
  "cashbackAmount": "16,086원",         // ⚠️ 금액만 파싱, 상세는 iframe
  "cardBenefitsDetailed": {             // ❌ iframe 내부
    "신한카드": "5% 즉시할인",
    "우리카드": "3% 적립"
  }
}
```

---

## 사용자 경험 관점에서

### 문제: 왜 일부 정보만 보이나?

**페이지 로드 시점 vs 사용자 상호작용**

```
┌─ 페이지 로드 (0.1초)
│  ├─ "카드 혜택" 섹션 ✅ 보임
│  └─ "기프트카드 60%" 섹션 ❌ 아직 로드 안됨 (절반만 보임)
│
└─ 사용자가 "혜택보기" 클릭 (1초 후)
   └─ iframe 로드 완료 → 60% 정보 표시
```

**우리 Extension이 할 수 있는 것:**
- ✅ 페이지 로드 시 즉시 이용 가능한 데이터 파싱
- ✅ Chrome Storage에 저장
- ✅ Auto Popup 즉시 표시

**우리 Extension이 할 수 없는 것:**
- ❌ iframe 내부 데이터 파싱
- ❌ 사용자 클릭 자동화 (우회 불가)
- ❌ 숨겨진 혜택 정보 추출

---

## 해결 방안 (향후)

### 옵션 1: MutationObserver 활용 (비권장)
```typescript
// ❌ 문제: 매우 느림, 페이지 성능 저하
const observer = new MutationObserver(() => {
  // iframe이 로드될 때까지 계속 감시
});
```

### 옵션 2: 사용자 상호작용 후 재파싱 (권장)
```typescript
// SubPopup에서 "더보기" 버튼 제공
// 사용자가 클릭하면 Coupang 페이지로 돌아가 수동 조회
```

### 옵션 3: 서버 사이드 파싱 (불가능)
```typescript
// ❌ 서버에서 크롤링하면 약관 위반
// Coupang API 접근 불가
```

---

## 결론

✅ **현재 구현은 올바릅니다.**

- 페이지 로드 시점에 접근 가능한 모든 데이터를 파싱
- iframe 내부 데이터는 보안상 접근 불가 (정상)
- 기프트카드 60% 할인은 사용자가 "혜택보기" 클릭 후 보임 (정상)

⚠️ **사용자에게 알릴 사항:**

> "일부 혜택(기프트카드, 쿠팡캐시)은 Coupang 페이지에서 '혜택보기' 버튼을 클릭하면 확인 가능합니다."
